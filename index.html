<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
<script>
  const CSV_URL = "https://raw.githubusercontent.com/Ybanna1/Wedding-seating-test/main/floorplan.csv";

  async function loadPeopleFromCSV() {
    const url = CSV_URL + "?cacheBust=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("CSV fetch failed");
    const csvText = await res.text();
    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });

    return parsed.data
      .filter(r => (r.displayName || "").trim())
      .map(r => ({
        displayName: String(r.displayName).trim(),
        name: (r.name ? String(r.name) : String(r.displayName)).toLowerCase().trim(),
        table: r.table ? String(r.table).trim() : ""
      }));
  }

  (async function initSearch(){
    let people = [];
    try {
      people = await loadPeopleFromCSV();
    } catch {
      people = [];
    }

    const fuse = new Fuse(people, { keys: ["name", "displayName"], threshold: 0.3, ignoreLocation: true });
    const searchEl = document.getElementById("search");
    const resultsDiv = document.getElementById("results");

    searchEl.addEventListener("input", function(){
      const q = this.value.trim();
      resultsDiv.innerHTML = "";
      if (!q) return;

      const out = fuse.search(q);
      if (!out.length) {
        resultsDiv.innerHTML = '<div class="entry">No match found</div>';
        return;
      }
      out.slice(0,50).forEach(({ item: p }) => {
        const div = document.createElement("div");
        div.className = "entry";
        div.textContent = p.table ? `${p.displayName} â€” Table ${p.table}` : p.displayName;
        resultsDiv.appendChild(div);
      });
    });
  })();
</script>
